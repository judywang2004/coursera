define("bundles/ondemand/components/discussionPrompt/DiscussionPrompt",["require","exports","module","react-with-addons","react-router","i18n!nls/ondemand","q","bundles/phoenix/lib/apiWrapper","jsuri","pages/open-course/common/constants","bundles/profile/constants/constants","bundles/phoenix/template/models/userIdentity","vendor/cnpm/fluxible.v0-4/addons/connectToStores","bundles/ondemand/stores/SessionStore","bundles/discussions/models/question","bundles/discussions/viewModels/viewContext","bundles/content-feedback/constants/ItemTypes","bundles/iconfont/Icon","bundles/phoenix/components/CML","js/lib/coursera.react-intl","bundles/discussions/components/repliesList/RepliesList","bundles/ondemand/components/discussionPrompt/DiscussionPromptComponents","bundles/ondemand/components/item/LightItemLayout","bundles/ondemand/components/LockingCover","bundles/discussions/actions/ThreadDetailsActions","bundles/discussions/utils/handleResponse","bundles/discussions/api/questions","css!./__styles__/DiscussionPrompt.css"],function(require,exports,module){"use strict";function _defaults(e,o){for(var r=Object.getOwnPropertyNames(o),t=0;t<r.length;t++){var s=r[t],n=Object.getOwnPropertyDescriptor(o,s);n&&n.configurable&&void 0===e[s]&&Object.defineProperty(e,s,n)}return e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):_defaults(t,e))}var a=function(){function defineProperties(n,s){for(var t=0;t<s.length;t++){var e=s[t];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(n,e.key,e)}}return function(e,t,s){return t&&defineProperties(e.prototype,t),s&&defineProperties(e,s),e}}(),O=function get(r,c,u){var s=!0;e:for(;s;){var t=r,i=c,a=u;s=!1,null===t&&(t=Function.prototype);var e=Object.getOwnPropertyDescriptor(t,i);if(void 0===e){var n=Object.getPrototypeOf(t);if(null===n)return void 0;r=n,c=i,u=a,s=!0,e=n=void 0;continue e}if("value"in e)return e.value;var o=e.get;if(void 0===o)return void 0;return o.call(a)}},e=require("react-with-addons"),m=require("react-router"),R=m.State,c=m.HistoryLocation,s=require("i18n!nls/ondemand"),E=require("q"),A=require("bundles/phoenix/lib/apiWrapper"),p=require("jsuri"),x=require("pages/open-course/common/constants"),v=require("bundles/profile/constants/constants"),t=v.savingStates,b=require("bundles/phoenix/template/models/userIdentity"),f=require("vendor/cnpm/fluxible.v0-4/addons/connectToStores"),r=require("bundles/ondemand/stores/SessionStore"),g=require("bundles/discussions/models/question"),i=require("bundles/discussions/viewModels/viewContext"),y=require("bundles/content-feedback/constants/ItemTypes"),C=require("bundles/iconfont/Icon"),I=require("bundles/phoenix/components/CML"),l=require("js/lib/coursera.react-intl"),P=l.FormattedNumber,S=l.FormattedMessage,h=require("bundles/discussions/components/repliesList/RepliesList"),o=require("bundles/ondemand/components/discussionPrompt/DiscussionPromptComponents"),q=o.Input,k=o.Saving,T=o.Completed,D=o.RespondedLearnersImage,N=require("bundles/ondemand/components/item/LightItemLayout"),L=require("bundles/ondemand/components/LockingCover"),j=require("bundles/discussions/actions/ThreadDetailsActions"),u=j.fetchAnswers,M=require("bundles/discussions/utils/handleResponse"),w=require("bundles/discussions/api/questions"),n="createdAtDesc";require("css!./__styles__/DiscussionPrompt.css");var d=function(o){function DiscussionPrompt(s,o){var e=this;_classCallCheck(this,DiscussionPrompt),O(Object.getPrototypeOf(DiscussionPrompt.prototype),"constructor",this).call(this,s,o),this.onRouteChange=function(s){var n=s.path,t=new p(n),o=parseInt(t.getQueryParamValue("page"),10),r=t.getQueryParamValue("answerId");e.setState({page:o||e.state.page,answerId:r||e.state.answerId})},this.receiveThreadData=function(s){var a=new i({course:e.props.course}),o=new M.HandleResponse(s),r=e.props.isSessionsEnabled&&e.props.sessionId,t=s.elements.find(function(e){return r?e.sessionId===r:void 0===e.sessionId});t.creator=o.getLinkedObject("creatorId",t.creatorId),t.flagDetails=o.getLinkedObject("flagId",t.flagId),t.viewContext=a,t.questionId=t.id,t.type="question";var c=new g(t,{parse:!0}),l=new i({question:c});e._isMounted&&(e.context.executeAction(u,{questionId:t.id,sort:n,page:e.state.page}),e.setState({question:t,questionViewContext:l,questionId:t.id,promptTitle:t.content.question,promptContent:t.content.details,learnerCount:t.answerCount,loaded:!0}))},this.state={learnerCount:void 0,questionViewContext:void 0,savingState:t.UNCHANGED,forumError:!1,previouslyCompleted:this.getProgress(s.courseProgress),page:1,answerId:void 0}}return _inherits(DiscussionPrompt,o),a(DiscussionPrompt,null,[{key:"propTypes",value:{course:e.PropTypes.object.isRequired,itemMetadata:e.PropTypes.object.isRequired,courseProgress:e.PropTypes.object.isRequired,savingStates:e.PropTypes.object.isRequired,isEnrolled:e.PropTypes.bool,isSessionsEnabled:e.PropTypes.bool,isSessionUpcoming:e.PropTypes.bool,sessionId:e.PropTypes.string},enumerable:!0},{key:"contextTypes",value:{router:e.PropTypes.func.isRequired,track:e.PropTypes.func.isRequired,executeAction:e.PropTypes.func.isRequired},enumerable:!0}]),a(DiscussionPrompt,[{key:"componentWillMount",value:function componentWillMount(){c.addChangeListener(this.onRouteChange),this.props.isSessionsEnabled&&this.props.isSessionUpcoming?this.setState({loaded:!0}):this.fetchThreadData()}},{key:"componentDidMount",value:function componentDidMount(){this._isMounted=!0}},{key:"componentWillReceiveProps",value:function componentWillReceiveProps(e){this.setState({previouslyCompleted:this.getProgress(e.courseProgress),savingState:e.savingStates[this.state.questionId]||t.UNCHANGED})}},{key:"componentDidUpdate",value:function componentDidUpdate(s,e){e.savingState!==this.state.savingState&&this.state.savingState===t.SAVING&&this.context.track("discussion_prompt.click.reply"),e.page!==this.state.page&&this.context.executeAction(u,{questionId:this.state.questionId,sort:n,page:this.state.page})}},{key:"componentWillUnmount",value:function componentWillUnmount(){this._isMounted=!1,c.removeChangeListener(this.onRouteChange)}},{key:"getProgress",value:function getProgress(e){return e.getItemProgress(this.context.router.getCurrentParams().item_id).isComplete()}},{key:"fetchThreadData",value:function fetchThreadData(){var e=this,t=(new p).addQueryParam("q","byPromptItem").addQueryParam("courseId",x.courseId).addQueryParam("itemId",this.context.router.getCurrentParams().item_id).addQueryParam("sort",n).addQueryParam("includes","creatorId,flagId,_links"),s=this.props.isSessionsEnabled&&this.props.sessionId;s&&t.addQueryParam("sessionId",s),E(w.get(t.toString())).then(this.receiveThreadData)["catch"](function(t){e.context.track("discussion_prompt.emit.forum_error"),e.setState({forumError:!0})}).done()}},{key:"renderLoading",value:function renderLoading(){return e.createElement("div",{className:"vertical-box align-items-vertical-center"},e.createElement(C,{name:"spinner",className:"cif-spin cif-3x"}))}},{key:"renderInput",value:function renderInput(){return e.createElement("div",null,e.createElement("div",{className:"color-hint-text participation-text"},s("Participation is optional")),e.createElement(q,{savingState:this.state.savingState,question:this.state.question,placeholder:s("Type your response here..."),questionViewContext:this.state.questionViewContext}),e.createElement(D,{questionId:this.state.questionId,responseCount:this.state.learnerCount}),e.createElement("div",{className:"horizontal-box align-items-absolute-center caption-text color-secondary-text"},this.state.learnerCount&&this.state.learnerCount>0?e.createElement("div",null,e.createElement(P,{value:this.state.learnerCount}),"Â ",e.createElement(S,{message:s("{learnerCount, plural, =1 { learner has} other { learners have}}\n     submitted a response."),learnerCount:this.state.learnerCount})):e.createElement("div",null,s("Be the first to submit a response"))))}},{key:"renderError",value:function renderError(){return e.createElement("div",{className:"horizontal-box align-items-absolute-center bgcolor-white c-prompt-card"},e.createElement("span",{className:"caption-text color-secondary-text"},s("Sorry, we were unable to retrieve a forum.")))}},{key:"renderCompleted",value:function renderCompleted(){return e.createElement("div",null,e.createElement(T,{showLink:this.state.previouslyCompleted,questionId:this.state.questionId}),e.createElement("div",{className:"c-thread-container"},e.createElement(h,{viewContext:this.state.questionViewContext,sort:n,page:this.state.page,questionId:this.state.questionId,answerId:this.state.answerId})))}},{key:"renderContent",value:function renderContent(){var s=this.state.savingState;if(s===t.SAVED||this.state.previouslyCompleted)return this.renderCompleted();if(s===t.UNCHANGED)return this.renderInput();if(s===t.SAVING)return e.createElement(k,null)}},{key:"renderBody",value:function renderBody(){var t=!b.get("authenticated")||!this.props.isEnrolled||this.props.isSessionUpcoming;return e.createElement("div",null,e.createElement("div",{className:"vertical-box align-items-vertical-center"},e.createElement("div",null,e.createElement("span",{className:"cif-stack cif-2x"},e.createElement("i",{className:"cif-circle cif-stack-2x c-prompt-icon"}),e.createElement("i",{className:"cif-comment cif-stack-1x cif-inverse comment-icon"}))),e.createElement("h4",{className:"c-prompt-title"},this.state.promptTitle)),e.createElement("span",{className:"body-2-text"},e.createElement(I,{cml:this.state.promptContent})),t?e.createElement(L,{itemMetadata:this.props.itemMetadata}):this.renderContent())}},{key:"render",value:function render(){var t=this.state.loaded;return e.createElement("div",{className:"rc-DiscussionPrompt"},e.createElement(N,{itemMetadata:this.props.itemMetadata,subItemId:this.state.questionId,itemType:y.DiscussionPrompt,isCard:!0},!this.state.forumError&&(t?this.renderBody():this.renderLoading()),this.state.forumError&&this.renderError()))}}]),DiscussionPrompt}(e.Component);module.exports=f(d,["CourseStore","ThreadDetailsStore","CourseMembershipStore"],function(e){var t=e.CourseStore,s=e.ThreadDetailsStore,n=e.CourseMembershipStore;return{course:t.getMetadata(),savingStates:s.savingStates,isEnrolled:n.isEnrolled(),isSessionsEnabled:r.isSessionsEnabled(),isSessionUpcoming:r.isUpcoming(),sessionId:r.getSessionId()}}),module.exports.BaseComp=d});